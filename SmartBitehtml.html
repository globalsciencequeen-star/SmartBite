<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>School Canteen QR Wallet System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>

  <style>
    /* Windows 11 / Glassmorphism Base Styles */
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e8ecf1, #f2f5f9);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .glass-container {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    /* Input Field Styling */
    .input-style {
        padding: 12px 16px;
        font-size: 15px;
        border: 1px solid #d6dae0;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        transition: border 0.2s, background-color 0.2s;
    }
    .input-style:focus {
      outline: none;
      border-color: #4685ff;
      background: rgba(255, 255, 255, 1);
    }

    /* Custom Scrollbar for Menu List */
    #menuTabContent::-webkit-scrollbar, #historyList::-webkit-scrollbar, #cartItems::-webkit-scrollbar {
        width: 6px;
    }
    #menuTabContent::-webkit-scrollbar-thumb, #historyList::-webkit-scrollbar-thumb, #cartItems::-webkit-scrollbar-thumb {
        background-color: rgba(70, 133, 255, 0.5);
        border-radius: 10px;
    }
    #menuTabContent::-webkit-scrollbar-track, #historyList::-webkit-scrollbar-track, #cartItems::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body onload="initApp()">

    <div id="mainWrapper" class="glass-container w-full max-w-lg md:max-w-6xl rounded-2xl p-6 md:p-8">

        <div id="statusBar" class="p-3 rounded-xl font-medium hidden transition-all duration-300 text-sm mb-4"></div>

        <div id="registrationView" class="max-w-md mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Student Canteen Registration</h1>
        <p class="text-center text-sm text-gray-500 mb-6">
            Create your Canteen Digital ID to set up your wallet, starting with **₹500.00**.
        </p>
        <form id="studentForm" class="space-y-4">
            <input type="text" id="name" placeholder="Full Name" class="input-style w-full" required />
            <input type="text" id="admission" placeholder="Admission No. (Unique ID)" class="input-style w-full" required />
            <input type="password" id="password" placeholder="4-digit Payment Password (PIN)" class="input-style w-full" required minlength="4" maxlength="4" />
            <button type="submit" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg">
                <i data-lucide="scan" class="w-5 h-5 mr-2 inline-block"></i> Generate Digital ID
            </button>
        </form>
    </div>

        <div id="qrView" class="hidden max-w-md mx-auto text-center">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Canteen Digital ID</h2>
        <p class="text-sm text-gray-600 mb-6">
            This QR Code contains your secure ID and wallet data. **Click it to simulate the canteen scanner and access the menu.**
        </p>
        <div class="p-6 bg-white rounded-xl shadow-2xl inline-block border border-gray-200">
            <a href="#" onclick="accessCanteen(event)" class="inline-block hover:scale-[1.03] transition-transform duration-300">
                <canvas id="qrCanvas" width="250" height="250" class="rounded-lg shadow-md"></canvas>
            </a>
        </div>
        <div id="qrUserDetails" class="mt-4 text-gray-700"></div>
    </div>

        <div id="appView" class="hidden w-full">

                <div class="mb-4">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-4">
                <h1 class="text-3xl font-extrabold text-gray-800 mb-2 md:mb-0">Canteen Order (Menu)</h1>
               
                <div id="userInfo" class="flex flex-col md:flex-row items-end md:items-center space-y-2 md:space-y-0 md:space-x-4 text-sm text-gray-600">
                                        <div class="flex items-center text-base font-medium text-gray-700">
                        <i data-lucide="user-circle" class="w-5 h-5 mr-1 text-blue-500"></i>
                        <span id="displayUserId" class="font-medium"></span>
                    </div>

                                        <div class="flex items-center p-2 rounded-xl bg-green-100 border border-green-300 shadow-sm">
                        <i data-lucide="wallet" class="w-5 h-5 mr-2 text-green-600"></i>
                        <span class="text-green-700 font-bold">Balance: </span>
                        <span id="walletBalance" class="font-bold ml-1 text-green-700">₹0.00</span>
                    </div>
                </div>
            </div>
        </div>

                <div class="flex justify-start border-b mb-6 text-lg font-semibold">
            <button onclick="setTabView('menu')" id="menuTabBtn" class="py-2 px-4 border-b-2 border-blue-600 text-blue-600 flex items-center transition-colors duration-200">
                <i data-lucide="utensils" class="w-5 h-5 mr-2"></i> Food Menu
            </button>
            <button onclick="setTabView('history')" id="historyTabBtn" class="py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center transition-colors duration-200 ml-4">
                <i data-lucide="history" class="w-5 h-5 mr-2"></i> History
            </button>
        </div>
       

        <div class="flex flex-col md:flex-row gap-6">

                        <div class="md:w-3/5">
                                <div id="menuTabContent" class="space-y-4 max-h-[65vh] overflow-y-auto pr-2">
                                    </div>

                                <div id="historyTabContent" class="hidden">
                    <div id="historyList" class="space-y-4 max-h-[65vh] overflow-y-auto pr-2">
                        <p class="text-gray-500 italic">No transactions recorded yet.</p>
                    </div>
                </div>
            </div>

                        <div class="md:w-2/5">
                <div class="sticky top-4 p-5 bg-white bg-opacity-80 backdrop-blur-md rounded-xl border border-gray-200 shadow-xl">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-600 flex items-center">
                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i> Your Cart
                        <span id="cartCountBadge" class="ml-2 px-2 py-0.5 text-xs font-bold text-white bg-red-500 rounded-full hidden">0</span>
                    </h3>
                    <div id="cartItems" class="space-y-3 min-h-[50px] max-h-48 overflow-y-auto pr-1">
                        <p id="emptyCartMessage" class="text-gray-500 italic">Cart is empty. Time to snack!</p>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <div class="flex justify-between items-center font-bold text-lg text-gray-800">
                            <span>Order Total:</span>
                            <span id="cartTotal">₹0.00</span>
                        </div>
                    </div>

                    <button onclick="openPasswordModal()" id="checkoutButton" disabled
                        class="mt-6 w-full py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg active:scale-[.99] flex items-center justify-center">
                        <i data-lucide="receipt-text" class="w-4 h-4 mr-2"></i>
                        Secure Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>
  </div>

    <div id="passwordModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 p-4">
    <div class="glass-container w-full max-w-sm rounded-xl p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <i data-lucide="shield-check" class="w-5 h-5 mr-2 text-blue-600"></i>
            Authorize Payment
        </h3>
        <p class="text-sm text-gray-600 mb-4">
            Confirm transaction of <strong id="modalTotal">₹0.00</strong>. Enter your ID and PIN for security.
        </p>

        <input type="text" id="paymentAdmissionId" placeholder="Admission ID (e.g., A1234)" class="input-style mb-3 w-full" required />
        <input type="password" id="paymentPassword" placeholder="4-digit PIN/Password" class="input-style mb-4 w-full" required minlength="4" maxlength="4" />

        <div id="modalMessage" class="text-sm text-red-500 mb-4 hidden font-medium"></div>

        <div class="flex space-x-3">
            <button onclick="closePasswordModal()"
                class="w-1/2 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-xl transition-all duration-200 active:scale-[.98]">
                Cancel
            </button>
            <button onclick="processPayment()"
                class="w-1/2 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition-all duration-200 active:scale-[.98]">
                Pay Now
            </button>
        </div>
    </div>
  </div>

  <script>
    // --- Global State & Data ---
    const STARTING_BALANCE = 500.00;
    let currentUser = null; // { name, admissionId, password, balance }
    let cart = []; // { id, name, price, quantity }
    let transactionHistory = []; // { orderId, total, items, date }
    let currentOrderId = 1000;
    let qrPayload = null; // Stores the secure user data for the QR code

    // --- DOM Element References ---
    let registrationView, qrView, appView, studentForm, statusBar;
    let menuTabContent, historyTabContent, menuTabBtn, historyTabBtn, historyList;
    let cartItemsDiv, cartTotalSpan, emptyCartMessage, checkoutButton, cartCountBadge;
    let passwordModal, modalTotal, paymentPasswordInput, paymentAdmissionIdInput, modalMessage;
    let displayUserId, walletBalanceSpan;
    let qrCanvas, qrUserDetails;

    const foodItems = [
      { id: 101, name: 'Margherita Pizza (Slice)', price: 80.00, description: 'Classic cheese and tomato slice', calories: 250 },
      { id: 102, name: 'Aloo Patty Burger', price: 45.00, description: 'Crispy potato patty with fresh veggies and mint mayo', calories: 320 },
      { id: 103, name: 'Masala Samosa (2 pcs)', price: 30.00, description: 'Spiced potato filling, deep-fried pastry', calories: 360 },
      { id: 104, name: 'Vada Pav', price: 25.00, description: 'Spicy potato fritter in a soft bun', calories: 200 },
      { id: 105, name: 'Plain Curd/Yogurt', price: 30.00, description: 'Probiotic, unsweetened fresh curd cup', calories: 100 },
      { id: 106, name: 'Vegetable Chowmein', price: 75.00, description: 'Stir-fried noodles with mixed vegetables', calories: 380 },
      { id: 107, name: 'Fresh Fruit Salad', price: 85.00, description: 'Mixed seasonal fruits (apple, banana, grapes)', calories: 120 },
      { id: 108, name: 'Chicken Kathi Roll', price: 110.00, description: 'Spiced chicken chunks wrapped in a paratha', calories: 450 },
      { id: 109, name: 'Rajma Chawal (Plate)', price: 95.00, description: 'Kidney beans curry with steamed rice', calories: 400 },
      { id: 110, name: 'Orange Juice (Fresh)', price: 50.00, description: '100% natural, freshly squeezed juice', calories: 180 },
    ];

    // --- Utility Functions ---
   
    // Formats currency in Indian Rupees
    function formatIndianRupee(amount) {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR'
        }).format(amount);
    }

    // Displays dynamic messages in the dedicated status bar
    function showStatusMessage(message, type = 'info') {
        statusBar.textContent = message;
        statusBar.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700', 'border-red-300', 'border-green-300', 'border-yellow-300', 'bg-gray-100', 'text-gray-600', 'border-gray-300');
        statusBar.classList.add('border');

        if (type === 'success') {
            statusBar.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
        } else if (type === 'error') {
            statusBar.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
        } else if (type === 'warning') {
            statusBar.classList.add('bg-yellow-100', 'text-yellow-700', 'border-yellow-300');
        } else { // info
            statusBar.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
        }

        // Automatically hide after a few seconds, except for errors
        if (type !== 'error') {
            setTimeout(() => {
                statusBar.classList.add('hidden');
            }, 4000);
        }
    }

    // --- Initialization and View Setup ---

    function initApp() {
        // Assign DOM elements
        registrationView = document.getElementById('registrationView');
        qrView = document.getElementById('qrView');
        appView = document.getElementById('appView');
        studentForm = document.getElementById('studentForm');
        statusBar = document.getElementById('statusBar');
        menuTabContent = document.getElementById('menuTabContent');
        historyTabContent = document.getElementById('historyTabContent');
        menuTabBtn = document.getElementById('menuTabBtn');
        historyTabBtn = document.getElementById('historyTabBtn');
        historyList = document.getElementById('historyList');
        cartItemsDiv = document.getElementById('cartItems');
        cartTotalSpan = document.getElementById('cartTotal');
        emptyCartMessage = document.getElementById('emptyCartMessage');
        checkoutButton = document.getElementById('checkoutButton');
        passwordModal = document.getElementById('passwordModal');
        modalTotal = document.getElementById('modalTotal');
        paymentPasswordInput = document.getElementById('paymentPassword');
        paymentAdmissionIdInput = document.getElementById('paymentAdmissionId');
        modalMessage = document.getElementById('modalMessage');
        displayUserId = document.getElementById('displayUserId');
        walletBalanceSpan = document.getElementById('walletBalance');
        qrCanvas = document.getElementById('qrCanvas');
        qrUserDetails = document.getElementById('qrUserDetails');
        cartCountBadge = document.getElementById('cartCountBadge');

        // Set initial view
        registrationView.classList.remove('hidden');
        qrView.classList.add('hidden');
        appView.classList.add('hidden');

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        studentForm.addEventListener('submit', handleRegistration);
    }

    function updateWalletDisplay() {
        if (currentUser) {
            walletBalanceSpan.textContent = formatIndianRupee(currentUser.balance);
           
            // Low balance warning
            if (currentUser.balance < 100 && currentUser.balance > 0) {
                showStatusMessage(`Warning: Your balance is low (${formatIndianRupee(currentUser.balance)}). Please recharge!`, 'warning');
            } else if (currentUser.balance <= 0) {
                showStatusMessage('Alert: Your wallet is empty. Recharging is required to order.', 'error');
            }
        }
    }

    function handleRegistration(e) {
        e.preventDefault();

        const name = document.getElementById('name').value.trim();
        const admissionId = document.getElementById('admission').value.trim();
        const password = document.getElementById('password').value;

        // Ensure fields are valid
        if (!name || !admissionId || password.length !== 4) {
          showStatusMessage('Please fill out all fields correctly (PIN must be 4 digits).', 'error');
          return;
        }

        const userData = {
            n: name, // name
            a: admissionId, // admissionId
            p: password, // password (PIN)
            b: STARTING_BALANCE.toFixed(2) // balance
        };

        // Securely store data for the QR code (Base64 encoded JSON)
        qrPayload = btoa(JSON.stringify(userData));

        // 1. Generate QR Code
        new QRious({
            element: qrCanvas,
            value: qrPayload,
            size: 250
        });

        // 2. Update QR View details
        qrUserDetails.innerHTML = `
            <p class="font-bold text-lg">${name}</p>
            <p class="text-blue-500">ID: ${admissionId}</p>
        `;

        // 3. Switch View: Registration -> QR
        registrationView.classList.add('hidden');
        qrView.classList.remove('hidden');

        showStatusMessage(`Registration successful! Your unique QR ID is ready.`, 'success');
    }
   
    function accessCanteen(e) {
        e.preventDefault(); // Stop the default link behavior
        if (!qrPayload) {
            showStatusMessage('Error: No registration data found. Please register first.', 'error');
            return;
        }

        // Simulate QR code scanning: Decode the data
        try {
            const decodedJson = atob(qrPayload);
            const loadedUserData = JSON.parse(decodedJson);

            // Set the global currentUser object
            currentUser = {
                name: loadedUserData.n,
                admissionId: loadedUserData.a,
                password: loadedUserData.p,
                balance: parseFloat(loadedUserData.b)
            };

            // 1. Switch View: QR -> App
            qrView.classList.add('hidden');
            appView.classList.remove('hidden');
           
            // 2. Initialize App Components
            displayUserId.textContent = `${currentUser.name} (ID: ${currentUser.admissionId})`;
            updateWalletDisplay();
            renderMenu();
            updateCartDisplay();

            showStatusMessage(`Canteen Access Granted for ${currentUser.name}. Welcome!`, 'info');

        } catch (error) {
            console.error("Error decoding QR data:", error);
            showStatusMessage('System Error: Could not process digital ID.', 'error');
        }

    }

    // --- Tab View Management ---

    function setTabView(view) {
        // Reset tabs
        menuTabBtn.classList.remove('border-blue-600', 'text-blue-600');
        menuTabBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
        historyTabBtn.classList.remove('border-blue-600', 'text-blue-600');
        historyTabBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');

        menuTabContent.classList.add('hidden');
        historyTabContent.classList.add('hidden');

        // Set active tab
        if (view === 'menu') {
            menuTabBtn.classList.add('border-blue-600', 'text-blue-600');
            menuTabBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
            menuTabContent.classList.remove('hidden');
        } else if (view === 'history') {
            historyTabBtn.classList.add('border-blue-600', 'text-blue-600');
            historyTabBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
            historyTabContent.classList.remove('hidden');
            renderHistory(); // Re-render history whenever tab is opened
        }
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
    }

    // --- Menu and Cart Functions (from previous version) ---

    function renderMenu() {
      menuTabContent.innerHTML = foodItems.map(item => `
        <div class="menu-item flex items-center justify-between p-4 bg-white bg-opacity-70 rounded-xl transition-all duration-200 hover:bg-opacity-90 hover:shadow-lg border border-gray-100">
          <div>
            <div class="text-lg font-semibold text-gray-800">${item.name}</div>
            <div class="text-sm text-gray-500">
                ${item.description} | <span class="font-bold text-orange-600">${item.calories} kcal</span>
            </div>
            <div class="mt-1 text-base font-bold text-blue-600">${formatIndianRupee(item.price)}</div>
          </div>
          <div class="flex items-center space-x-3">
            <button onclick="addToCart(${item.id})"
                    class="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-150 active:scale-95 shadow-md">
                <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      `).join('');
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    function addToCart(itemId) {
      const item = foodItems.find(i => i.id === itemId);
      if (!item) return;

      const existingCartItem = cart.find(c => c.id === itemId);

      if (existingCartItem) {
        existingCartItem.quantity += 1;
      } else {
        cart.push({
          id: item.id,
          name: item.name,
          price: item.price,
          quantity: 1
        });
      }

      showStatusMessage(`Added 1x ${item.name} to cart!`, 'info');
      updateCartDisplay();
    }

    function updateCartItemQuantity(itemId, delta) {
        const itemIndex = cart.findIndex(c => c.id === itemId);

        if (itemIndex > -1) {
            cart[itemIndex].quantity += delta;
            if (cart[itemIndex].quantity <= 0) {
                cart.splice(itemIndex, 1);
            }
        }
        updateCartDisplay();
    }

    function updateCartDisplay() {
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const formattedTotal = formatIndianRupee(total);
      cartTotalSpan.textContent = formattedTotal;

      if (totalItems > 0) {
        cartCountBadge.textContent = totalItems;
        cartCountBadge.classList.remove('hidden');
      } else {
        cartCountBadge.classList.add('hidden');
      }

      // Cart Item Rendering
      if (cart.length === 0) {
        cartItemsDiv.innerHTML = '';
        emptyCartMessage.classList.remove('hidden');
      } else {
        emptyCartMessage.classList.add('hidden');
        cartItemsDiv.innerHTML = cart.map(item => `
          <div class="cart-item flex justify-between items-center p-2 rounded-lg bg-gray-50 border border-gray-200">
            <div class="flex-grow">
              <span class="font-medium text-gray-700">${item.name}</span>
              <span class="text-xs text-gray-500 block">(${formatIndianRupee(item.price)} ea.)</span>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="updateCartItemQuantity(${item.id}, -1)" class="p-1 text-gray-500 hover:text-red-500 transition-colors rounded-full active:scale-95">
                    <i data-lucide="minus" class="w-4 h-4"></i>
                </button>
                <span class="font-bold w-4 text-center">${item.quantity}</span>
                <button onclick="updateCartItemQuantity(${item.id}, 1)" class="p-1 text-gray-500 hover:text-green-500 transition-colors rounded-full active:scale-95">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <span class="ml-4 font-semibold text-gray-800 w-16 text-right">${formatIndianRupee(item.price * item.quantity)}</span>
          </div>
        `).join('');
      }

      // Checkout Button Logic
      checkoutButton.disabled = cart.length === 0;

      // Low balance warning on checkout button
      if (total > currentUser.balance) {
        checkoutButton.classList.add('bg-red-500', 'hover:bg-red-600');
        checkoutButton.classList.remove('bg-green-500', 'hover:bg-green-600');
        checkoutButton.innerHTML = '<i data-lucide="wallet-x" class="w-4 h-4 mr-2"></i> Insufficient Funds';
        checkoutButton.disabled = true; // explicitly disable if total exceeds balance
      } else if (cart.length > 0) {
        checkoutButton.classList.add('bg-green-500', 'hover:bg-green-600');
        checkoutButton.classList.remove('bg-red-500', 'hover:bg-red-600');
        checkoutButton.innerHTML = '<i data-lucide="receipt-text" class="w-4 h-4 mr-2"></i> Secure Checkout';
        checkoutButton.disabled = false;
      }

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // --- Payment/Modal Functions (from previous version) ---

    function openPasswordModal() {
        if (!currentUser || cart.length === 0) return;

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
       
        if (total > currentUser.balance) {
            showStatusMessage(`Payment Blocked: Insufficient Balance! Total: ${formatIndianRupee(total)} > Wallet: ${formatIndianRupee(currentUser.balance)}`, 'error');
            return;
        }

        modalTotal.textContent = formatIndianRupee(total);
        paymentPasswordInput.value = '';
        paymentAdmissionIdInput.value = '';
        modalMessage.classList.add('hidden');
        passwordModal.classList.remove('hidden');
        paymentAdmissionIdInput.focus();
    }

    function closePasswordModal() {
        passwordModal.classList.add('hidden');
        paymentPasswordInput.value = '';
        paymentAdmissionIdInput.value = '';
    }

    function processPayment() {
        const enteredPassword = paymentPasswordInput.value;
        const enteredAdmissionId = paymentAdmissionIdInput.value;
        const orderTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        if (enteredPassword.length !== 4 || !enteredAdmissionId) {
            modalMessage.textContent = 'Please enter both your Admission ID and 4-digit PIN.';
            modalMessage.classList.remove('hidden');
            return;
        }

        // --- Security Check ---
        const isIdMatch = enteredAdmissionId === currentUser.admissionId;
        const isPasswordMatch = enteredPassword === currentUser.password;

        if (isIdMatch && isPasswordMatch) {
           
            // Check balance again
            if (orderTotal > currentUser.balance) {
                modalMessage.textContent = 'Error: Insufficient Balance during final confirmation.';
                modalMessage.classList.remove('hidden');
                return;
            }

            // 1. Deduct Funds
            currentUser.balance -= orderTotal;
            currentUser.balance = parseFloat(currentUser.balance.toFixed(2));

            // 2. Log Transaction History
            currentOrderId++;
            const newTransaction = {
                orderId: `CANT${currentOrderId}`,
                total: orderTotal,
                items: [...cart], // Deep copy of cart items
                date: new Date().toLocaleString('en-IN', {
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                })
            };
            transactionHistory.unshift(newTransaction); // Add to the start

            // 3. Update UI
            updateWalletDisplay();
           
            showStatusMessage(
                `Order ${newTransaction.orderId} Confirmed! Amount: ${formatIndianRupee(orderTotal)}. New Balance: ${formatIndianRupee(currentUser.balance)}.`,
                'success'
            );

            // 4. Clear Cart and Modal
            cart = [];
            updateCartDisplay();
            closePasswordModal();

        } else {
            modalMessage.textContent = 'Invalid Admission ID or PIN. Payment failed.';
            modalMessage.classList.remove('hidden');
        }
    }

    // --- Transaction History Functions (from previous version) ---

    function renderHistory() {
        if (transactionHistory.length === 0) {
            historyList.innerHTML = '<p class="text-gray-500 italic p-4 text-center">No transactions recorded yet. Place your first order!</p>';
            return;
        }

        historyList.innerHTML = transactionHistory.map(transaction => `
            <div class="p-4 bg-white bg-opacity-70 rounded-xl border border-blue-100 shadow-lg hover:shadow-xl transition-shadow duration-200">
                <div class="flex justify-between items-center border-b pb-2 mb-2">
                    <span class="text-lg font-bold text-blue-700">${transaction.orderId}</span>
                    <span class="text-xl font-extrabold text-green-600">${formatIndianRupee(transaction.total)}</span>
                </div>
                <div class="text-sm text-gray-500 mb-3 flex items-center">
                    <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                    <span>${transaction.date}</span>
                </div>
                <p class="font-semibold text-gray-700 mb-1">Items Ordered:</p>
                <ul class="list-disc list-inside space-y-0.5 text-sm text-gray-600 pl-4">
                    ${transaction.items.map(item => `
                        <li>${item.quantity} x ${item.name} (${formatIndianRupee(item.price * item.quantity)})</li>
                    `).join('')}
                </ul>
            </div>
        `).join('');
       
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
    }
  </script>

</body>
</html>